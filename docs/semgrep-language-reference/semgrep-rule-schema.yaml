$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://example.com/semgrep-rule-schema.parser-aligned.v1.yaml"
title: "Semgrep Rule File Schema (Parser-Aligned Draft)"
type: object
required:
  - rules
additionalProperties: false

properties:
  rules:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/rule"

$defs:
  ruleId:
    type: string
    pattern: "^[a-zA-Z0-9._-]+$"

  semverLike:
    type: string
    pattern: "^[0-9]+\\.[0-9]+\\.[0-9]+$"

  stringList:
    type: array
    items:
      type: string

  language:
    description: >
      Parser accepts many languages and aliases. This schema keeps a practical
      parser-aligned set and allows unknown strings for forward compatibility.
    anyOf:
      - enum:
          - rust
          - python
          - py
          - python2
          - python3
          - typescript
          - ts
          - javascript
          - js
          - go
          - golang
          - hcl
          - terraform
          - tf
          - generic
          - regex
          - none
      - type: string

  languages:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/language"

  severity:
    enum:
      - ERROR
      - WARNING
      - INFO
      - INVENTORY
      - EXPERIMENT
      - CRITICAL
      - HIGH
      - MEDIUM
      - LOW

  paths:
    type: object
    additionalProperties: false
    properties:
      include:
        $ref: "#/$defs/stringList"
      exclude:
        $ref: "#/$defs/stringList"

  fixRegex:
    type: object
    required:
      - regex
      - replacement
    additionalProperties: false
    properties:
      regex:
        type: string
      replacement:
        type: string
      count:
        type: integer
        minimum: 0

  metadata:
    type: object
    additionalProperties: true

  options:
    type: object
    additionalProperties: true

  # ---------------------------
  # Legacy query formula (v1)
  # ---------------------------

  legacyFormulaValue:
    oneOf:
      - type: string
      - $ref: "#/$defs/legacyFormulaObject"

  focusMetavariable:
    type: object
    required:
      - focus-metavariable
    additionalProperties: false
    properties:
      focus-metavariable:
        oneOf:
          - type: string
          - type: array
            minItems: 1
            items:
              type: string

  metavariableRegex:
    type: object
    required:
      - metavariable-regex
    additionalProperties: false
    properties:
      metavariable-regex:
        type: object
        required:
          - metavariable
          - regex
        additionalProperties: false
        properties:
          metavariable:
            type: string
          regex:
            type: string
          constant-propagation:
            type: boolean

  metavariableType:
    type: object
    required:
      - metavariable-type
    additionalProperties: false
    properties:
      metavariable-type:
        type: object
        required:
          - metavariable
        additionalProperties: false
        properties:
          metavariable:
            type: string
          language:
            type: string
          type:
            type: string
          types:
            type: array
            minItems: 1
            items:
              type: string
        oneOf:
          - required: [type]
          - required: [types]

  metavariablePattern:
    type: object
    required:
      - metavariable-pattern
    additionalProperties: false
    properties:
      metavariable-pattern:
        type: object
        required:
          - metavariable
        additionalProperties: true
        properties:
          metavariable:
            type: string
          language:
            type: string
          pattern:
            type: string
          patterns:
            type: array
            minItems: 1
            items:
              $ref: "#/$defs/patternsItem"
          pattern-either:
            type: array
            minItems: 1
            items:
              $ref: "#/$defs/legacyFormulaObject"
          pattern-regex:
            type: string
        oneOf:
          - required: [pattern]
          - required: [patterns]
          - required: [pattern-either]
          - required: [pattern-regex]

  metavariableComparison:
    type: object
    required:
      - metavariable-comparison
    additionalProperties: false
    properties:
      metavariable-comparison:
        type: object
        required:
          - comparison
        additionalProperties: false
        properties:
          metavariable:
            type: string
          comparison:
            type: string
          strip:
            type: boolean
          base:
            type: integer

  metavariableAnalysis:
    type: object
    required:
      - metavariable-analysis
    additionalProperties: false
    properties:
      metavariable-analysis:
        type: object
        required:
          - analyzer
          - metavariable
        additionalProperties: false
        properties:
          metavariable:
            type: string
          analyzer:
            oneOf:
              - enum: [entropy, entropy_v2, redos]
              - type: object
                required: [kind]
                additionalProperties: true
                properties:
                  kind:
                    enum: [entropy, entropy_v2, redos]
                  mode:
                    enum: [lax, strict, default]

  metavariableName:
    type: object
    required:
      - metavariable-name
    additionalProperties: false
    properties:
      metavariable-name:
        type: object
        required:
          - metavariable
        additionalProperties: false
        properties:
          metavariable:
            type: string
          module:
            type: string
          modules:
            type: array
            minItems: 1
            items:
              type: string
        oneOf:
          - required: [module]
          - required: [modules]

  semgrepInternalMetavariableName:
    type: object
    required:
      - semgrep-internal-metavariable-name
    additionalProperties: false
    properties:
      semgrep-internal-metavariable-name:
        type: object
        required:
          - metavariable
        additionalProperties: false
        properties:
          metavariable:
            type: string
          kind:
            type: string
          module:
            type: string
          modules:
            type: array
            minItems: 1
            items:
              type: string
          fqn:
            type: string
          fqns:
            type: array
            minItems: 1
            items:
              type: string
        anyOf:
          - required: [kind]
          - required: [module]
          - required: [modules]
          - required: [fqn]
          - required: [fqns]

  patternsItem:
    anyOf:
      - $ref: "#/$defs/legacyFormulaObject"
      - $ref: "#/$defs/focusMetavariable"
      - $ref: "#/$defs/metavariableRegex"
      - $ref: "#/$defs/metavariableType"
      - $ref: "#/$defs/metavariablePattern"
      - $ref: "#/$defs/metavariableComparison"
      - $ref: "#/$defs/metavariableAnalysis"
      - $ref: "#/$defs/metavariableName"
      - $ref: "#/$defs/semgrepInternalMetavariableName"

  legacyFormulaObject:
    type: object
    additionalProperties: false
    properties:
      pattern:
        type: string
      pattern-regex:
        type: string
      patterns:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/patternsItem"
      pattern-either:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/legacyFormulaObject"
      pattern-not:
        $ref: "#/$defs/legacyFormulaValue"
      pattern-inside:
        $ref: "#/$defs/legacyFormulaValue"
      pattern-not-inside:
        $ref: "#/$defs/legacyFormulaValue"
      pattern-not-regex:
        type: string
      semgrep-internal-pattern-anywhere:
        $ref: "#/$defs/legacyFormulaValue"
    oneOf:
      - required: [pattern]
      - required: [pattern-regex]
      - required: [patterns]
      - required: [pattern-either]
      - required: [pattern-not]
      - required: [pattern-inside]
      - required: [pattern-not-inside]
      - required: [pattern-not-regex]
      - required: [semgrep-internal-pattern-anywhere]

  # ---------------------------
  # Match query formula (v2)
  # ---------------------------

  whereItem:
    oneOf:
      - type: object
        required: [focus]
        additionalProperties: false
        properties:
          focus:
            oneOf:
              - type: string
              - type: array
                minItems: 1
                items:
                  type: string
      - type: object
        required: [comparison]
        additionalProperties: false
        properties:
          comparison:
            type: string
          strip:
            type: boolean
          base:
            type: integer
      - type: object
        required: [metavariable]
        additionalProperties: true
        properties:
          metavariable:
            type: string
          language:
            type: string
          pattern:
            type: string
          regex:
            type: string
          all:
            type: array
            minItems: 1
            items:
              $ref: "#/$defs/matchFormula"
          any:
            type: array
            minItems: 1
            items:
              $ref: "#/$defs/matchFormula"
          not:
            $ref: "#/$defs/matchFormula"
          inside:
            $ref: "#/$defs/matchFormula"
          anywhere:
            $ref: "#/$defs/matchFormula"
          type:
            type: string
          types:
            type: array
            minItems: 1
            items:
              type: string
          analyzer:
            oneOf:
              - enum: [entropy, entropy_v2, redos]
              - type: object

  matchFormula:
    oneOf:
      - type: string
      - $ref: "#/$defs/matchFormulaObject"

  matchFormulaObject:
    type: object
    additionalProperties: false
    properties:
      pattern:
        type: string
      regex:
        type: string
      all:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/matchFormula"
      any:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/matchFormula"
      not:
        $ref: "#/$defs/matchFormula"
      inside:
        $ref: "#/$defs/matchFormula"
      anywhere:
        $ref: "#/$defs/matchFormula"
      where:
        type: array
        items:
          $ref: "#/$defs/whereItem"
      as:
        type: string
      fix:
        type: string
    oneOf:
      - required: [pattern]
      - required: [regex]
      - required: [all]
      - required: [any]
      - required: [not]
      - required: [inside]
      - required: [anywhere]

  # ---------------------------
  # Taint mode
  # ---------------------------

  taintOldEntry:
    type: object
    additionalProperties: true
    properties:
      pattern:
        type: string
      pattern-regex:
        type: string
      patterns:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/patternsItem"
      pattern-either:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/legacyFormulaObject"
      exact:
        oneOf:
          - type: boolean
          - enum: ["true", "false"]
      by-side-effect:
        oneOf:
          - type: boolean
          - enum: ["true", "false", "only"]
      control:
        type: boolean
      label:
        type: string
      requires:
        oneOf:
          - type: string
          - type: array
            minItems: 1
      from:
        type: string
      to:
        type: string
      replace-labels:
        type: array
        minItems: 1
        items:
          type: string
      not-conflicting:
        type: boolean
      at-exit:
        type: boolean
    oneOf:
      - required: [pattern]
      - required: [pattern-regex]
      - required: [patterns]
      - required: [pattern-either]

  taintOldList:
    type: array
    minItems: 1
    items:
      $ref: "#/$defs/taintOldEntry"

  taintNewEntry:
    oneOf:
      - type: string
      - allOf:
          - $ref: "#/$defs/matchFormulaObject"
          - type: object
            additionalProperties: true
            properties:
              exact:
                oneOf:
                  - type: boolean
                  - enum: ["true", "false"]
              by-side-effect:
                oneOf:
                  - type: boolean
                  - enum: ["true", "false", "only"]
              control:
                type: boolean
              label:
                type: string
              requires:
                oneOf:
                  - type: string
                  - type: array
                    minItems: 1
              from:
                type: string
              to:
                type: string
              replace-labels:
                type: array
                minItems: 1
                items:
                  type: string
              not-conflicting:
                type: boolean
              at-exit:
                type: boolean

  taintObject:
    type: object
    additionalProperties: false
    required:
      - sources
      - sinks
    properties:
      sources:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/taintNewEntry"
      sinks:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/taintNewEntry"
      propagators:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/taintNewEntry"
      sanitizers:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/taintNewEntry"

  # ---------------------------
  # Join mode
  # ---------------------------

  joinRename:
    type: object
    required: [from, to]
    additionalProperties: false
    properties:
      from:
        type: string
      to:
        type: string

  joinRef:
    type: object
    required: [rule]
    additionalProperties: false
    properties:
      rule:
        type: string
      as:
        type: string
      renames:
        type: array
        items:
          $ref: "#/$defs/joinRename"

  joinObject:
    type: object
    additionalProperties: false
    required: [on]
    properties:
      refs:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/joinRef"
      rules:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: true
      on:
        type: array
        minItems: 1
        items:
          type: string
    oneOf:
      - required: [refs]
      - required: [rules]

  # ---------------------------
  # Rule object
  # ---------------------------

  rule:
    type: object
    required:
      - id
    additionalProperties: true
    properties:
      id:
        $ref: "#/$defs/ruleId"
      min-version:
        $ref: "#/$defs/semverLike"
      max-version:
        $ref: "#/$defs/semverLike"
      version:
        type: string
      mode:
        description: >
          `step` is parser-supported legacy behavior even though it is absent
          in semgrep-interfaces rule_schema_v1 mode enum.
        enum: [search, taint, join, extract, step]

      message:
        type: string
      languages:
        $ref: "#/$defs/languages"
      severity:
        $ref: "#/$defs/severity"

      pattern:
        type: string
      patterns:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/patternsItem"
      pattern-either:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/legacyFormulaObject"
      pattern-regex:
        type: string
      match:
        $ref: "#/$defs/matchFormula"

      # Taint (old style)
      pattern-sources:
        $ref: "#/$defs/taintOldList"
      pattern-sinks:
        $ref: "#/$defs/taintOldList"
      pattern-propagators:
        $ref: "#/$defs/taintOldList"
      pattern-sanitizers:
        $ref: "#/$defs/taintOldList"

      # Taint (new style)
      taint:
        $ref: "#/$defs/taintObject"

      # Join mode
      join:
        $ref: "#/$defs/joinObject"

      # Extract mode
      extract:
        type: string
      dest-language:
        type: string
      dest-rules:
        type: object
        additionalProperties: false
        properties:
          include:
            type: array
            items:
              $ref: "#/$defs/ruleId"
          exclude:
            type: array
            items:
              $ref: "#/$defs/ruleId"
      transform:
        enum: [no_transform, unquote_string, concat_json_string_array]
      reduce:
        enum: [concat, separate]

      fix:
        type: string
      fix-regex:
        $ref: "#/$defs/fixRegex"
      paths:
        $ref: "#/$defs/paths"
      metadata:
        $ref: "#/$defs/metadata"
      options:
        $ref: "#/$defs/options"

      # Dependency-aware (search mode extension)
      r2c-internal-project-depends-on:
        type: object
        additionalProperties: true

    allOf:
      # Extract mode: parser currently uses legacy formula parser, not `match`.
      - if:
          properties:
            mode:
              const: extract
          required: [mode]
        then:
          required: [id, languages, dest-language, extract]
          anyOf:
            - required: [pattern]
            - required: [patterns]
            - required: [pattern-either]
            - required: [pattern-regex]

      # Join mode.
      - if:
          properties:
            mode:
              const: join
          required: [mode]
        then:
          required: [id, message, severity, join]

      # New-style taint mode (presence of top-level `taint` key).
      - if:
          required: [taint]
        then:
          required: [id, message, languages, severity, taint]

      # Old-style taint mode (`mode: taint` without top-level `taint`).
      - if:
          properties:
            mode:
              const: taint
            taint: false
          required: [mode]
        then:
          required: [id, message, languages, severity, pattern-sources, pattern-sinks]

      # Search mode (explicit or implicit default).
      - if:
          properties:
            taint: false
            join: false
            extract: false
          allOf:
            - anyOf:
                - properties: { mode: { const: search } }
                  required: [mode]
                - properties: { mode: false }
        then:
          required: [id, message, languages, severity]
          anyOf:
            - required: [pattern]
            - required: [patterns]
            - required: [pattern-either]
            - required: [pattern-regex]
            - required: [match]
            - required: [r2c-internal-project-depends-on]

# Parser-only constraints not fully expressible here:
# - `pattern-either` cannot contain negated branches (`pattern-not`).
# - `patterns` / `all` must contain at least one positive term unless parsing a metavariable-pattern.
